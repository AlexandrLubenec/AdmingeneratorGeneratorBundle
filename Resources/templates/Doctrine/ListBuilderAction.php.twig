{% use '../CommonAdmin/ListAction/index.php.twig' %}
{% use '../CommonAdmin/ListAction/pager.php.twig' %}
{% use '../CommonAdmin/ListAction/sorter.php.twig' %}
{% use '../CommonAdmin/ListAction/filters.php.twig' %}
<?php

namespace Admingenerated\{{ namespace_prefix }}{{ bundle_name }}\BaseController;

{{ block('index_use') }}

use Admingenerator\GeneratorBundle\Controller\Doctrine\BaseController as BaseDoctrineController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\RedirectResponse;

use Pagerfanta\Pagerfanta;
use Pagerfanta\Adapter\DoctrineORMAdapter as PagerAdapter;

// these import the "@Template" annotations
use Sensio\Bundle\FrameworkExtraBundle\Configuration\Template;

class ListController extends BaseDoctrineController
{
    {{- block('index') -}}
    
    {{- block('pager') -}}
    
    {{- block('sorter') -}}
    
    {{- block('filters') -}}
    
    protected function getQuery()
    {
        $query = $this->getDoctrine()
                    ->getEntityManager()
                    ->createQueryBuilder()
                    ->select('q')
                    ->from('{{ model }}', 'q');
        
        $this->processSort($query); 
        $this->processFilters($query); 

        return $query->getQuery();
    }
    
    protected function processSort($query)
    {
        if($this->getSortColumn()) { 
            if (!strstr($this->getSortColumn(), '.')) { //direct column
                $query->orderBy('q.'.$this->getSortColumn(), $this->getSortOrder());
            } else {
                list($table, $column) = explode('.', $this->getSortColumn(), 2);
                $this->addJoinFor($table, $query);
                $query->orderBy($this->getSortColumn(), $this->getSortOrder());
            }
        }
    }
    
    protected function getFilterForm()
    {
        $filters = $this->getFilters();
        
        {% for filter in builder.filters.display %}
            {% if 'entity' == builder.getFieldGuesser().getDbType(model, filter) %}
        
        if ($filters['{{ filter }}']) {
             $this->getDoctrine()->getEntityManager()->getUnitOfWork()->registerManaged($filters['{{ filter }}'], array($filters['{{ filter }}']->getId()), array());
        }
        
            {% endif %}
        {% endfor %}
        
        return $this->createForm(new FiltersType(), $this->getFilters());
    }
    
    protected function addJoinFor($table, $query)
    {
        $query->leftJoin('q.'.$table, $table);
    }
    
    protected function processFilters($query)
    {
        $filterObject = $this->getFilters();
        
        $queryFilter = $this->get('admingenerator.queryfilter.doctrine');
        $queryFilter->setQuery($query);

        {% for filter in builder.filters.display %}
        
        if(isset($filterObject['{{ filter }}']) && null !== $filterObject['{{ filter }}']) {
            $queryFilter->add{{ builder.getFieldGuesser().getDbType(model, filter)|classify }}Filter("{{ filter }}", $filterObject['{{ filter }}']);
        }
        {% endfor %}
        
    }
}
